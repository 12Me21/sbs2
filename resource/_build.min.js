var Highlight={lang:{}};(function(){var keywords=["BREAK","COMMON","CONTINUE","ELSE","END","ENDIF","REM","REPEAT","THEN","WEND"];var keywords_sb3=["STOP"];var keywords_sb4=["OTHERWISE","ENDCASE","LOOP","ENDLOOP"];var argKeywords=["CALL","DATA","DEC","DIM","ELSEIF","EXEC","FOR","GOSUB","GOTO","IF","INC","INPUT","LINPUT","NEXT","ON","OUT","PRINT","READ","RESTORE","RETURN","SWAP","UNTIL","USE","VAR","WHILE"];var argKeywords_sb4=["CASE","WHEN","DEFOUT","TPRINT","CONST","ENUM"];var builtinFunctions=["ABS","ACCEL","ACLS","ACOS","ARYOP","ASC","ASIN","ATAN","ATTR","BACKCOLOR","BEEP","BGMCHK","BGMCLEAR","BGMCONT","BGMPAUSE","BGMPLAY","BGMSET","BGMSETD","BGMSTOP","BGMVAR","BGMVOL","BIN$","BIQUAD","BQPARAM","BREPEAT","BUTTON","CEIL","CHKCALL","CHKCHR","CHKFILE","CHKLABEL","CHKMML","CHKVAR","CHR$","CLASSIFY","CLIPBOARD","CLS","COLOR","CONTROLLER","COPY","COS","COSH","DEG","DELETE","DIALOG","DTREAD","EFCSET","EFCWET","EXP","FADE","FADECHK","FFT","FFTWFN","FILES","FILL","FLOOR","FORMAT$","GBOX","GCIRCLE","GCLIP","GCLS","GCOLOR","GCOPY","GFILL","GLINE","GLOAD","GPAINT","GPSET","GPUTCHR","GSAVE","GTRI","GYROA","GYROSYNC","GYROV","HEX$","IFFT","INKEY$","INSTR","KEY","LEFT$","LEN","LOAD","LOCATE","LOG","MAX","MID$","MIN","OPTION","PCMCONT","PCMSTOP","PCMSTREAM","PCMVOL","POP","POW","PRGDEL","PRGEDIT","PRGGET$","PRGINS","PRGNAME$","PRGSET","PRGSIZE","PROJECT","PUSH","RAD","RANDOMIZE","RENAME","RGB","RIGHT$","RINGCOPY","RND","RNDF","ROUND","RSORT","SAVE","SCROLL","SGN","SHIFT","SIN","SINH","SNDSTOP","SORT","SPANIM","SPCHK","SPCHR","SPCLR","SPCOL","SPCOLOR","SPCOLVEC","SPDEF","SPFUNC","SPHIDE","SPHITINFO","SPHITRC","SPHITSP","SPHOME","SPLINK","SPOFS","SPPAGE","SPROT","SPSCALE","SPSET","SPSHOW","SPSTART","SPSTOP","SPUNLINK","SPUSED","SPVAR","SQR","STICK","STR$","SUBST$","TALK","TALKCHK","TALKSTOP","TAN","TANH","TMREAD","TOUCH","UNSHIFT","VAL","VSYNC","WAIT","WAVSET","WAVSETA","XSCREEN","VIBRATE"];var builtinFunctions_sb3=["BACKTRACE","BGANIM","BGCHK","BGCLIP","BGCLR","BGCOLOR","BGCOORD","BGCOPY","BGFILL","BGFUNC","BGGET","BGHIDE","BGHOME","BGLOAD","BGOFS","BGPAGE","BGPUT","BGROT","BGSAVE","BGSCALE","BGSCREEN","BGSHOW","BGSTART","BGSTOP","BGVAR","BGMPRG","BGMPRGA","DISPLAY","DLCOPEN","EFCOFF","EFCON","FONTDEF","GOFS","GPAGE","GPRIO","GSPOIT","MICDATA","MICSAVE","MICSTART","MICSTOP","MPEND","MPGET","MPNAME$","MPRECV","MPSEND","MPSET","MPSTART","MPSTAT","STICKEX","RGBREAD","SPCLIP","VISIBLE","WIDTH","XOFF","XON","GPUTCHR16"];var builtinFunctions_sb4=["PCMPOS","TYPEOF","ARRAY#","ARRAY%","ARRAY$","RESIZE","INSERT","REMOVE","INSPECT","DEFARGC","DEFARG","DEFOUTC","INT","FLOAT","LAST","FONTINFO","PERFBEGIN","PERFEND","SYSPARAM","METAEDIT","METALOAD","METASAVE","XCTRLSTYLE","MOUSE","MBUTTON","IRSTART","IRSTOP","IRSTATE","IRREAD","IRSPRITE","KEYBOARD","TCPIANO","TCHOUSE","TCROBOT","TCFISHING","TCBIKE","TCVISOR","LOADG","LOADV","SAVEG","SAVEV","ANIMDEF","TSCREEN","TPAGE","TCOLOR","TLAYER","TPUT","TFILL","THOME","TOFS","TROT","TSCALE","TSHOW","THIDE","TBLEND","TANIM","TSTOP","TSTART","TCHK","TVAR","TCOPY","TSAVE","TLOAD","TARRAY","TUPDATE","TFUNC","GTARGET","RGBF","HSV","GPGET","GARRAY","GUPDATE","GSAMPLE","SPLAYER","STOP","LAYER","LMATRIX","LFILTER","LCLIP","BEEPPIT","BEEPPAN","BEEPVOL","BEEPSTOP","BGMPITCH","BGMWET","EFCEN","SNDMSBAL","SNDMVOL","PRGSEEK","XSUBSCREEN","ENVSTAT","ENVTYPE","ENVLOAD","ENVSAVE","ENVINPUT$","ENVFOCUS","ENVPROJECT","ENVLOCATE","PUSHKEY","HELPGET","HELPINFO","UISTATE","UIMASK","UIPUSHCMPL","DATE$","TIME$","RESULT","CALLIDX","FREEMEM","MILLISEC","MAINCNT"];var systemVariables=["CALLIDX","CSRX","CSRY","CSRZ","DATE$","ERRLINE","ERRNUM","ERRPRG","EXTFEATURE","FREEMEM","HARDWARE","MAINCNT","MICPOS","MICSIZE","MILLISEC","MPCOUNT","MPHOST","MPLOCAL","PCMPOS","PRGSLOT","RESULT","SYSBEEP","TABSTEP","VERSION"];function isAlpha(c){return c>="A"&&c<="Z"||c>="a"&&c<="z"}function isDigit(c){return c>="0"&&c<="9"}function isInExpr(type){return type=="argkeyword"||type=="function"||type=="operator"||type=="name"||type=="equals"||type=="expr"}function main(code,callback,sb4){var i=-1,c;function next(){i++;c=code.charAt(i)}function jump(pos){i=pos-1;next()}var prev=0;var prevType="start";function push(type,cssType){var word=code.substring(prev,i);prev=i;if(type=="word"){var upper=word.toUpperCase();if(sb4!=true&&(upper=="TRUE"||upper=="FALSE")){type="number";cssType="true-false number"}else if(upper=="DIV"||upper=="MOD"||upper=="AND"||upper=="OR"||upper=="XOR"||upper=="NOT"){type="operator";cssType="word-operator operator"}else if(upper=="DEF"){type="def";cssType="def keyword"}else if(sb4!=false&&(upper=="T"&&c=="?")){word+=c;next();prev=i;type="keyword";cssType="keyword"}else if(keywords.indexOf(upper)>=0||sb4==false&&keywords_sb3.indexOf(upper)>=0||sb4!=false&&keywords_sb4.indexOf(upper)>=0){type="keyword";cssType="keyword"}else if(argKeywords.indexOf(upper)>=0||sb4!=false&&argKeywords_sb4.indexOf(upper)>=0){type="argkeyword";cssType="keyword"}else if(prevType=="def"){type="name";cssType="name"}else{var fPos=i;while(c==" "||c=="\t")next();var isFunc=false;if(isInExpr(prevType)){if(c=="(")isFunc=true}else{isFunc=true;if(c=="["){isFunc=false}else if(c=="="){next();if(c!="=")isFunc=false}}if(isFunc){type="function";if(builtinFunctions.indexOf(upper)!=-1||sb4!=true&&builtinFunctions_sb3.indexOf(upper)!=-1||sb4!=false&&builtinFunctions_sb4.indexOf(upper)!=-1)cssType="statement function";else if(upper=="TO"||upper=="STEP")cssType="to-step keyword";else cssType="statement"}else{type="variable";if(sb4!=true&&systemVariables.indexOf(upper)!=-1)cssType="variable function";else cssType="variable"}jump(fPos)}}else if(type=="label"){if(isInExpr(prevType)){type="string";cssType="label-string string"}else{cssType="label"}}else{if(cssType==undefined)cssType=type}callback(word,cssType);if(type!="whitespace")prevType=type}next();while(c){if(isAlpha(c)||c=="_"){next();while(isAlpha(c)||isDigit(c)||c=="_")next();if(c=="#"||c=="%"||c=="$")next();push("word")}else if(isDigit(c)||c=="."){while(isDigit(c))next();if(c=="."){next();if(isDigit(c)){next();while(isDigit(c))next()}else{if(c=="#")next();push("number");continue}}if(c=="E"||c=="e"){var ePos=i;next();if(c=="+"||c=="-")next();if(isDigit(c)){next();while(isDigit(c))next()}else{jump(ePos);push();continue}}if(c=="#")next();push("number")}else switch(c){case'"':next();while(c&&c!='"'&&c!="\n"&&c!="\r")next();if(c=='"')next();push("string");break;case"'":next();while(c&&c!="\n"&&c!="\r")next();push("comment");break;case"&":next();switch(c){case"&":next();push("operator");break;case"H":case"h":var hPos=i;next();if(isDigit(c)||c>="A"&&c<="F"||c>="a"&&c<="f"||c=="_"&&sb4!=false){next();while(isDigit(c)||c>="A"&&c<="F"||c>="a"&&c<="f"||c=="_"&&sb4!=false)next();push("number")}else{jump(hPos);push()}break;case"B":case"b":var bPos=i;next();if(c=="0"||c=="1"||c=="_"&&sb4!=false){next();while(c=="0"||c=="1"||c=="_"&&sb4!=false)next();push("number")}else{jump(bPos);push()}break;default:push()}break;case"@":next();while(isDigit(c)||isAlpha(c)||c=="_")next();push("label");break;case"#":next();if(isDigit(c)||isAlpha(c)||c=="_"){next();while(isDigit(c)||isAlpha(c)||c=="_")next();if(c=="#"||c=="%"||c=="$")next();push("number","constant number")}else{if(c=="#"||c=="%"||c=="$"){next();push("number","constant number")}else{push()}}break;case"|":next();if(c=="|"){next();push("operator")}else{push()}break;case"<":next();if(c=="="||c=="<")next();push("operator");break;case">":next();if(c=="="||c==">")next();push("operator");break;case"=":next();if(c=="="){next();push("operator")}else{push("equals")}break;case"!":next();if(c=="=")next();push("operator");break;case"+":case"-":case"*":case"/":next();push("operator");break;case"\\":next();if(sb4==false){push(undefined,false)}else{while(c&&c!="\n"&&c!="\r")next();next();push("whitespace")}break;case";":case",":case"[":case"(":next();push("expr",false);break;case"\n":next();push("linebreak",false);break;case":":case")":case"]":next();push("noexpr",false);break;case" ":case"\t":next();push("whitespace",false);break;case"?":next();push("argkeyword","question keyword");break;default:next();push(undefined,false)}}push("eof")}Highlight.lang.sb=function(code,callback){return main(code,callback)};Highlight.lang.sb3=function(code,callback){return main(code,callback,false)};Highlight.lang.sb4=function(code,callback){return main(code,callback,true)}})();Highlight.none=function(code,callback){callback(code)};Highlight.cLike=function(code,callback){var i=-1,c;var prev=0;function next(){i++;c=code.charAt(i)}function push(type){var word=code.substring(prev,i);prev=i;if(type=="word"){if(["if","while","for","switch","case","return","do","break","continue","else"].indexOf(word)>=0)type="keyword";else type="variable"}callback(word,type)}next();while(c){if(c=="/"){next();if(c=="/"){next();while(c&&c!="\n")next();push("comment")}else{push()}}else if(c=='"'){next();while(c&&c!="\n"&&c!='"')next();if(c=='"')next();push("string")}else if(c=="'"){next();while(c&&c!="\n"&&c!="'")next();if(c=="'")next();push("string")}else if(isAlpha(c)||c=="_"||c=="$"){next();while(isAlphaNum(c)||c=="_"||c=="$")next();push("word")}else{next();push("shit")}}function isAlpha(c){return c>="A"&&c<="Z"||c>="a"&&c<="z"}function isAlphaNum(c){return c>="A"&&c<="Z"||c>="a"&&c<="z"||c>="0"&&c<="9"}};["c","js","javascript"].forEach(function(lang){Highlight.lang[lang]=Highlight.cLike});Highlight.highlight=function(text,lang){if(lang)var hl=Highlight.lang[lang.toLowerCase()];hl=hl||Highlight.none;var doc=document.createDocumentFragment();var prev=NaN;var buffer="";function callback(word,cls){if(cls==prev){buffer+=word;return}var element=document.createElement("span");element.textContent=buffer;if(prev)element.className=prev;doc.appendChild(element);prev=cls;buffer=word}hl(text,callback);callback("",NaN);return doc};var Parse={lang:{}};(function(){var c,i,cache=null,code;var editorCache={video:{},audio:{},youtube:{}};var skipNextLineBreak;var textBuffer;var curr,output;var openBlocks;var stack;var startOfLine;var leadingSpaces;var blocks;function scan(){}function init(scanFunc,myBlocks,text){scan=scanFunc;code=text;if(cache)for(type in cache)for(arg in cache[type])cache[type][arg].forEach(function(x){x.used=false});blocks=myBlocks;openBlocks=0;leadingSpaces=0;startOfLine=true;skipNextLineBreak=false;textBuffer="";output=curr=options.root();stack=[{node:curr,type:"root"}];stack.top=function(){return stack[stack.length-1]};restore(0)}function restore(pos){i=pos-1;scan()}function eatChar(chr){if(c==chr){scan();return true}}function matchNext(str){return code.substr(i,str.length)==str}function readUrl(allow){var start=i;var depth=0;if(allow)while(c){if(eatChar("[")){depth++}else if(c=="]"){depth--;if(depth<0)break;scan()}else scan()}else{while(c){if(/[-\w\$\.+!*',;/\?:@=&#%~]/.test(c)){scan()}else if(eatChar("(")){depth++}else if(c==")"){depth--;if(depth<0)break;scan()}else break}}return code.substring(start,i)}function isUrlChar(c){return c&&/[-\w\$\.+!*'(,;/\?:@=&#%~]/.test(c)}function stackContains(type){for(var i=0;i<stack.length;i++){if(stack[i].type==type){return true}}return false}function top_is(type){var top=stack.top();return top&&top.type==type}function endBlock(){flushText();var item=stack.pop();if(item.node&&item.node.block)skipNextLineBreak=true;if(stack.length){var i=stack.length-1;while(!stack[i].node){i--}curr=stack[i].node;openBlocks--}else{curr=null}}function addBlock(node){flushText();options.append(curr,node);if(node.block)skipNextLineBreak=true;else skipNextLineBreak=false}function flushText(){if(textBuffer){options.append(curr,options.text(textBuffer));textBuffer=""}}function addLineBreak(){if(skipNextLineBreak){skipNextLineBreak=false}else{flushText();addBlock(options.lineBreak())}}function addText(text){if(text){textBuffer+=text;skipNextLineBreak=false}}function endAll(){flushText();while(stack.length)endBlock()}function findUnusedCached(cache,type,arg){var list=cache[type][arg];if(!list)return null;for(var i=0;i<list.length;i++){if(!list[i].used)return list[i]}return null}function startBlock(type,data,arg){data.type=type;if(type){openBlocks++;if(openBlocks>options.maxDepth)throw"too deep nestted blocks";var node=tryGetCached(cache,type,arg&&arg[""],function(){return blocks[type](arg)});data.node=node;if(node.block)skipNextLineBreak=true;flushText();options.append(curr,node);curr=node}stack.push(data);return data}function isUrlStart(){if(code[i-1]&&/\w/.test(code[i-1]))return false;return matchNext("http://")||matchNext("https://")||matchNext("sbs:")}function tryGetCached(cache,type,arg,make){var node;if(cache&&type&&cache[type]){var item=findUnusedCached(cache,type,arg);if(item){item.used=true;node=item.node}}if(!node&&type){node=make();if(cache&&cache[type]){if(!cache[type][arg])cache[type][arg]=[];cache[type][arg].push({node:node,used:true})}}return node}var options=Parse.options;Parse.lang["12y"]=function(codeInput,preview){init(function(){if(c=="\n"||!c)lineStart();else if(c!=" ")startOfLine=false;else if(startOfLine)leadingSpaces++;i++;c=code.charAt(i)},options,codeInput);var tags={spoiler:"spoiler",align:"align",sub:"subscript",sup:"superscript",anchor:"anchor",bg:"bg"};while(c){if(eatChar("\n")){endLine()}else if(eatChar("\\")){if(c=="\n"){flushText();addBlock(options.lineBreak())}else addText(c);scan()}else if(c=="{"){readEnv()}else if(eatChar("}")){if(stackContains(null)){closeAll(false)}else{addText("}")}}else if(c=="*"){if(startOfLine&&(code[i+1]=="*"||code[i+1]==" ")){var headingLevel=0;while(eatChar("*"))headingLevel++;if(headingLevel>3)headingLevel=3;if(eatChar(" "))startBlock("heading",{},headingLevel);else addMulti("*",headingLevel)}else{doMarkup("bold",options.bold)}}else if(c=="/"){doMarkup("italic",options.italic)}else if(c=="_"){doMarkup("underline",options.underline)}else if(c=="~"){doMarkup("strikethrough",options.strikethrough)}else if(startOfLine&&eatChar(">")){startBlock("quote",{},{})}else if(startOfLine&&eatChar("-")){textBuffer="";if(eatChar("-")){var count=2;while(eatChar("-"))count++;if(c=="\n"||!c){addBlock(options.line());skipNextLineBreak=true}else{addMulti("-",count)}}else if(eatChar(" ")){startBlock("list",{level:leadingSpaces},{});startBlock("item",{level:leadingSpaces})}else addText("-")}else if(c=="]"&&stack.top().inBrackets){scan();if(stack.top().big){if(eatChar("]"))endBlock();else addText("]")}else endBlock()}else if(c=="|"){var top=stack.top();if(top.type=="cell"){scan();var row=top.row;var table=top.row.table;var eaten=eatChar("\n");if(eaten&&eatChar("|")){if(table.columns==null)table.columns=row.cells;endBlock();if(top_is("row"))endBlock();var cells=0;table.rowspans=table.rowspans.map(function(span){cells++;return span-1}).filter(function(span){return span>0});var row=startBlock("row",{table:table,cells:cells});row.header=eatChar("*");startCell(row)}else{row.cells++;textBuffer=textBuffer.replace(/ *$/,"");if(table.columns!=null&&row.cells>table.columns){endBlock();if(top_is("row"))endBlock();if(top_is("table"))endBlock();if(eaten)addLineBreak()}else{endBlock();startCell(row)}}}else if(startOfLine){scan();table=startBlock("table",{columns:null,rowspans:[]},{});row=startBlock("row",{table:table,cells:0});row.header=eatChar("*");startCell(row)}else{scan();addText("|")}}else if(eatChar("`")){if(eatChar("`")){if(eatChar("`")){start=i;while(c&&c!="\n"&&c!="`")scan();var language=code.substring(start,i).trim().toLowerCase();var eaten=eatChar("\n");start=i;i=code.indexOf("```",i);addBlock(options.code({"":language},code.substring(start,i!=-1?i:code.length)));skipNextLineBreak=eaten;if(i!=-1){restore(i+3)}else{restore(code.length)}}else{addText("``")}}else{start=i;var codeText="";while(c){if(c=="`"){if(code[i+1]=="`"){if(i==start+1&&codeText[0]==" ")codeText=codeText.substr(1);scan()}else break}codeText+=c;scan()}addBlock(options.icode({},codeText));scan()}}else if(readLink()){}else{addText(c);scan()}}endAll();return output.node;function endAll(){flushText();while(stack.length){endBlock()}}function readBracketedLink(embed){if(eatChar("[")){if(eatChar("[")){var start=i;var part2=false;var url=readUrl(true);if(eatChar("]")){if(eatChar("]")){}else if(eatChar("["))part2=true}if(embed)var type=urlType(url);else type="link";if(type=="youtube"){addBlock(options.youtube({"":url},preview));if(part2)addText("[")}else{startBlock(type,{big:true},{"":url},preview);if(part2)stack.top().inBrackets=true;else{addText(url);endBlock()}}return true}else{addText("[")}}return false}function readEnv(){if(!eatChar("{"))return false;startBlock(null,{});lineStart();var start=i;if(eatChar("#")){var name=readTagName();var props=readProps();var func=tags[name];if(func&&!(name=="spoiler"&&stackContains("spoiler"))){startBlock(func,{},props)}else{addBlock(options.invalid(code.substring(start,i),"invalid tag"))}}lineStart();return true}function startCell(row){var props={};if(eatChar("#"))Object.assign(props,readProps());if(props.rs)row.table.rowspans.push(props.rs-1);if(props.cs)row.cells+=props.cs-1;if(row.header)props.h=true;startBlock("cell",{row:row},props);while(eatChar(" ")){}}function split1(string,sep){var n=string.indexOf(sep);if(n==-1)return[string,null];else return[string.substr(0,n),string.substr(n+sep.length)]}function readTagName(){var start=i;while(c>="a"&&c<="z"){scan()}if(i>start)return code.substring(start,i)}function readProps(){var start=i;var end=code.indexOf(" ",i);if(end<0)end=code.length;var end2=code.indexOf("\n",i);if(end2>=0&&end2<end)end=end2;end2=code.indexOf("}",i);if(end2>=0&&end2<end)end=end2;end2=code.indexOf("{",i);if(end2>=0&&end2<end)end=end2;restore(end);eatChar(" ");var propst=code.substring(start,end);var props={};propst.split(",").forEach(function(x){var pair=split1(x,"=");if(pair[1]==null)pair[1]=true;props[pair[0]]=pair[1]});return props}function addMulti(text,count){while(count-- >0)addText(text)}function readLink(){var embed=eatChar("!");if(readBracketedLink(embed)||readPlainLink(embed))return true;else if(embed){addText("!");return true}}function readPlainLink(embed){if(isUrlStart()){var url=readUrl();var after=eatChar("[");if(embed)var type=urlType(url);else type="link";if(type=="youtube"){addBlock(options.youtube({"":url},preview));if(after)addText("[")}else{startBlock(type,{inBrackets:after},{"":url},preview);if(!after){addText(url);endBlock()}}return true}}function closeAll(force){while(stack.length){var top=stack.top();if(top.type=="root"){break}if(!force&&top.type==null){endBlock();break}endBlock()}}function endLine(){while(1){var top=stack.top();if(top.type=="heading"||top.type=="quote"){endBlock()}else if(top.type=="item"){if(top.type=="item")endBlock();var indent=0;while(eatChar(" "))indent++;if(c!="-"){while(top_is("list"))endBlock();addMulti(" ",indent)}else{scan();while(eatChar(" ")){}if(indent==top.level){startBlock("item",{level:indent})}else if(indent>top.level){startBlock("list",{level:indent},{});startBlock("item",{level:indent})}else{while(1){top=stack.top();if(top&&top.type=="list"){if(top.level<=indent){break}else{endBlock()}}else{startBlock("list",{level:indent},{});break}}startBlock("item",{level:indent})}break}}else{addLineBreak();break}}}function urlType(url){if(/(\.mp3(?!\w)|\.ogg(?!\w)|\.wav(?!\w)|#audio$)/.test(url))return"audio";if(/(\.mp4(?!\w)|\.mkv(?!\w)|#video$)/.test(url))return"video";if(/(?:https?:\/\/)?(?:www\.)?youtu\.?be(?:\.com)?\/?.*(?:watch|embed)?(?:.*v=|v\/|\/)([\w\-_]+)\&?/.test(url))return"youtube";return"image"}function doMarkup(type,create){var symbol=c;scan();if(canStartMarkup(type)){startBlock(type,{})}else if(canEndMarkup(type)){endBlock()}else{addText(symbol)}}function canStartMarkup(type){return(!code[i-2]||char_in(code[i-2]," \t\n({'\""))&&(c&&!char_in(c," \t\n,'\""))&&!stackContains(type)}function canEndMarkup(type){return top_is(type)&&!char_in(code[i-2]," \t\n,'\"")&&(!c||char_in(c," \t\n-.,:!?')}\""))}function char_in(chr,list){return chr&&list.indexOf(chr)!=-1}function lineStart(){startOfLine=true;leadingSpaces=0}};Parse.lang.bbcode=function(codeArg,preview){var noNesting={spoiler:true};var blocks={b:options.bold,i:options.italic,u:options.underline,s:options.strikethrough,sup:options.superscript,sub:options.subscript,h1:function(){return options.heading(1)},h2:function(){return options.heading(2)},h3:function(){return options.heading(3)},table:options.table,tr:options.row,td:options.cell,th:function(arg,opt){return options.cell(Object.assign({h:true},opt))},code:true,align:options.align,url:options.link,youtube:true,audio:true,video:true,img:true,list:options.list,spoiler:options.spoiler,quote:options.quote,anchor:options.anchor,item:options.item};init(function(){i++;c=code.charAt(i)},blocks,codeArg);var specialBlock={url:function(args,contents){var node=options.link({"":contents});options.append(node,options.text(contents));return node},code:function(args,contents){var inline=args[""]=="inline";args[""]=args.lang;if(inline)return options.icode(args,contents);if(contents[0]=="\n")contents=contents.substr(1);return options.code(args,contents)},youtube:function(args,contents){return options.youtube({"":contents},preview)},img:function(args,contents){return options.image({"":contents})},audio:function(args,contents){return options.audio({"":contents})},video:function(args,contents){return options.video({"":contents})}};var point=0;while(c){if(eatChar("[")){point=i-1;if(eatChar("/")){var name=readTagName();if(!eatChar("]")||!name){cancel()}else{if(name=="list"&&stack.top().type=="item")endBlock(point);if(name==stack.top().type){endBlock(point);if(name=="td"||name=="th"||name=="tr"){while(eatChar(" ")||eatChar("\n")){}}}else{addBlock(options.invalid(code.substring(point,i),"unexpected closing tag"))}}}else{var name=readTagName();if(!name||!blocks[name]){if(eatChar("*")&&eatChar("]")){if(stack.top().type=="item")endBlock(point);var top=stack.top();if(top.type=="list"){startBlock("item",{},{})}else cancel()}else{cancel()}}else{var arg=true,args={};if(eatChar("=")){var start=i;if(eatChar('"')){start++;while(c&&c!='"')scan();if(c=='"'){arg=code.substring(start,i-1);scan()}}else{while(c&&c!="]"&&c!=" ")scan();if(c=="]"||c==" ")arg=code.substring(start,i)}}if(eatChar(" ")){args=readArgList()||{}}if(arg!=true)args[""]=arg;if(eatChar("]")){if(specialBlock[name]&&!(name=="url"&&arg!=true)){var endTag="[/"+name+"]";var end=code.indexOf(endTag,i);if(end<0)cancel();else{var contents=code.substring(i,end);restore(end+endTag.length);var node=tryGetCached(cache,name,contents,function(){return specialBlock[name](args,contents)});addBlock(node);if(node.block)skipNextLineBreak=true}}else if(name!="item"&&blocks[name]&&!(noNesting[name]&&stackContains(name))){if(name=="tr"||name=="table"){while(eatChar(" ")||eatChar("\n")){}}startBlock(name,{},args)}else addBlock(options.invalid(code.substring(point,i),"invalid tag"))}else{cancel()}}}}else if(readPlainLink()){}else if(eatChar("\n")){addLineBreak()}else{addText(c);scan()}}endAll();return output.node;function cancel(){restore(point);addText(c);scan()}function readPlainLink(){if(isUrlStart()){var url=readUrl();addBlock(specialBlock.url({},url));return true}}function readArgList(){var args={};while(1){var start=i;while(isTagChar(c))scan();var key=code.substring(start,i);if(eatChar("=")){if(eatChar('"')){start=i;while(c&&c!='"'&&c!="\n")scan();if(eatChar('"'))args[key]=code.substring(start,i-2);else return null}else{start=i;while(c&&c!=" "&&c!="]"&&c!="\n")scan();if(c=="]"){args[key]=code.substring(start,i);return args}else if(eatChar(" "))args[key]=code.substring(start,i-1);else return null}}else if(eatChar(" ")){args[key]=true}else if(c=="]"){args[key]=true;return args}else return null}}function readTagName(){var start=i;while(isTagChar(c))scan();return code.substring(start,i)}function isTagChar(c){return c>="a"&&c<="z"||c>="A"&&c<="Z"||c>="0"&&c<="9"}};Parse.fallback=function(text,preview){var options=Parse.options;var root=options.root();i=0;code=text;output=root;var linkRegex=/\b(?:https?:\/\/|sbs:)[-\w\$\.+!*'(),;/\?:@=&#%]*/g;var result;var out="",last=0;while(result=linkRegex.exec(text)){options.append(root,options.text(text.substring(last,result.index)));var link=options.link({"":result[0]});options.append(link,options.text(result[0]));options.append(root,link);last=result.index+result[0].length}options.append(root,options.text(text.substr(last)));return root.node};Parse.parseLang=function(text,lang,preview){options=Parse.options;i=0;code=text;if(code==undefined||code=="")return options.root().node;if(preview){cache=editorCache}else{cache=null}try{var parser=Parse.lang[lang]||Parse.fallback;return parser(text,preview)}catch(e){try{if(!output){output=options.root()}options.append(output,options.error(e,e.stack));options.append(output,options.text(code.substr(i)));return output.node}catch(e){alert("Unrecoverable parser error! please report this!\n"+e+"\n"+e.stack)}}}})();(function(){var document=window.document;var parserElement=document.createElement("a");function parseURL(url){if(!/^[a-z][a-z0-9+\.\-]:/i.test(url))return null;parserElement.href=url;try{var pathname=parserElement.pathname;if(pathname&&pathname[0]!="/")pathname="/"+pathname;return{protocol:parserElement.protocol,hostname:parserElement.hostname,port:parserElement.port,pathname:pathname,search:parserElement.search,hash:parserElement.hash}}catch(e){return null}}function creator(tag){return function(){return{node:document.createElement(tag)}}}function newEvent(name){var event=document.createEvent("Event");event.initEvent(name,true,true);return event}function getYoutube(id,callback){var x=new XMLHttpRequest;x.open("GET","https://www.googleapis.com/youtube/v3/videos?part=snippet&id="+id+"&key=AIzaSyBKka_xlF5pV4SMKLtQGIhOgyQsjF7UI-U");x.onload=function(){if(x.status!=200)return;try{var json=JSON.parse(x.responseText);var video=json.items[0];callback(video)}catch(e){}};x.send()}function defaultProtocol(){if(window.location.protocol=="http:")return"http:";else return"https:"}function getYoutubeID(url){var match=url.match(/(?:https?:\/\/)?(?:www\.)?youtu\.?be(?:\.com)?\/?.*(?:watch|embed)?(?:.*v=|v\/|\/)([\w\-_]+)\&?/);if(match)return match[1];return null}function urlProtocol(url){var match=url.match(/^([-\w]+:)([^]*)$/);if(match)return[match[1].toLowerCase(),match[2]];return[null,url]}Parse.options={maxDepth:10,append:function(parent,child){parent=parent.branch||parent.node;parent.appendChild(child.node)},kill:function(node,before){var parent=node.parentNode;parent.insertBefore(before,node);while(node.childNodes.length)parent.insertBefore(node.firstChild,node);parent.removeChild(node)},text:function(text){return{node:document.createTextNode(text)}},lineBreak:creator("br"),line:creator("hr"),invalid:function(text,reason){var node=document.createElement("span");node.className="invalid";node.title=reason;node.textContent=text;return{node:node}},code:function(args,contents){var language=args[""];var node=document.createElement("pre");node.setAttribute("data-lang",language);node.appendChild(Highlight.highlight(contents,language||"sb"));return{block:true,node:node}},icode:function(args,contents){var node=document.createElement("code");node.textContent=contents;return{node:node,block:false}},audio:function(args){var node=document.createElement("audio");node.setAttribute("controls","");node.setAttribute("src",args[""]);return{block:true,node:node}},video:function(args){var url=args[""];var node=document.createElement("video");node.setAttribute("controls","");node.setAttribute("src",url);node.setAttribute("shrink","");node.onplaying=function(){node.dispatchEvent(newEvent("videoclicked"))};return{block:true,node:node}},youtube:function(args,preview){var url=args[""];var protocol=defaultProtocol();var match=getYoutubeID(url);var link=document.createElement("a");var div=document.createElement("div");div.className="youtube";div.appendChild(link);link.href=url;if(match){link.style.backgroundImage='url("'+protocol+"//i.ytimg.com/vi/"+match+"/mqdefault.jpg"+'")';var time=url.match(/[&?](?:t|start)=(\w+)/);var end=url.match(/[&?](?:end)=(\w+)/);var loop=url.match(/[&?]loop(=|&|$)/);if(!preview)getYoutube(match,function(data){var title=document.createElement("div");title.className="pre videoTitle";title.textContent=data.snippet.title;link.appendChild(title);link.appendChild(document.createElement("br"));title=document.createElement("div");title.className="pre videoAuthor";title.textContent=data.snippet.channelTitle;link.appendChild(title)});var ifc=document.createElement("span");link.appendChild(ifc);link.onclick=function(e){e.preventDefault();div.dispatchEvent(newEvent("beforeSizeChange"));var iframe=document.createElement("iframe");var src="https://www.youtube-nocookie.com/embed/"+match+"?autoplay=1";if(time)src+="&start="+time[1];if(end)src+="&end="+end[1];if(loop)src+="&loop=1&playlist="+match;iframe.src=src;ifc.appendChild(iframe);div.className="youtube playingYoutube";div.dispatchEvent(newEvent("afterSizeChange"))};var stop=document.createElement("button");stop.textContent="x";stop.onclick=function(e){e.preventDefault();div.dispatchEvent(newEvent("beforeSizeChange"));ifc.textContent="";div.className="youtube";div.dispatchEvent(newEvent("afterSizeChange"))};div.appendChild(stop)}return{block:true,node:div}},bg:function(opt){var node=document.createElement("span");var color=opt[""];if(color){node.setAttribute("data-bgcolor",color)}return{node:node}},root:function(){var node=document.createDocumentFragment();return{block:true,node:node}},bold:creator("b"),italic:creator("i"),underline:creator("u"),strikethrough:creator("s"),heading:function(level){return{block:true,node:document.createElement("h"+(level+1))}},quote:function(args){var name=args[""];var node=document.createElement("blockquote");if(name){var cite=document.createElement("cite");cite.textContent=name;node.appendChild(cite);node.appendChild(document.createElement("br"))}return{block:true,node:node}},list:function(args){if(args[""]!=undefined){var list=document.createElement("ol");list.style.listStyleType=args[""]}else list=document.createElement("ul");return{block:true,node:list}},item:function(index){return{block:true,node:document.createElement("li")}},link:function(args){var url=args[""];if(/^ *javascript:/i.test(url))url="";var protocol=urlProtocol(url);if(protocol[0]=="sbs:"){var node=Nav.link(protocol[1])}else{var node=document.createElement("a");node.setAttribute("target","_blank");if(!protocol[0]){if(url[0]=="#"){}else{url=defaultProtocol()+"//"+url}}else{}node.href=url}return{node:node}},table:function(opts){var container=document.createElement("div");container.className="tableContainer";var node=document.createElement("table");container.appendChild(node);return{block:true,node:container,branch:node}},row:creator("tr"),cell:function(opt){var node=opt.h?document.createElement("th"):document.createElement("td");if(opt.rs)node.rowSpan=opt.rs;if(opt.cs)node.colSpan=opt.cs;if(opt.c){if(opt.c[0]=="#")node.style.backgroundColor=opt.c;node.setAttribute("data-bgcolor",opt.c)}if(opt.a){node.style.textAlign=opt.a}node.className="cell";return{node:node}},image:function(args){var url=args[""];var node=document.createElement("img");node.setAttribute("src",url);node.setAttribute("tabindex","-1");node.setAttribute("shrink","");node.setAttribute("loading","");node.onerror=node.onload=function(){node.removeAttribute("loading")};return{node:node,block:true}},error:function(e,stack){var node=document.createElement("div");node.className="error";node.appendChild(document.createTextNode("Markup parsing error: "));var err=document.createElement("code");err.textContent=e;node.appendChild(err);node.appendChild(document.createTextNode("\nPlease report this!"));if(stack){var pre=document.createElement("pre");pre.textContent=stack;node.appendChild(pre)}return{node:node,block:true}},align:function(args){var node=document.createElement("div");var arg=args[""];if(arg=="left"||arg=="right"||arg=="center")node.style.textAlign=arg;return{node:node,block:true}},superscript:creator("sup"),subscript:creator("sub"),anchor:function(args){var name=args[""];var node=document.createElement("a");node.name="_anchor_"+name;return{node:node,block:true}},spoiler:function(args){var button=document.createElement("button");button.onclick=function(){if(this.getAttribute("data-show")==null)this.setAttribute("data-show","");else this.removeAttribute("data-show")};button.className="spoilerButton";var name=args[""];if(name==true)name="spoiler";button.textContent=name;var box=document.createElement("div");box.className="spoiler";var node=document.createDocumentFragment();node.appendChild(button);node.appendChild(box);return{block:true,node:node,branch:box}}}})();if(!window.devicePixelRatio)window.devicePixelRatio=1;String.prototype.split1=function(sep){var n=this.indexOf(sep);if(n==-1)return[this,null];else return[this.substr(0,n),this.substr(n+sep.length)]};if(!Object.assign)Object.assign=function(dest,src){for(key in src)dest[key]=src[key];return dest};if(!HTMLElement.prototype.replaceChildren)HTMLElement.prototype.replaceChildren=function(child){this.textContent="";if(child)this.appendChild(child)};if(!HTMLElement.prototype.remove)HTMLElement.prototype.remove=function(){if(this.parentNode)this.parentNode.removeChild(this)};if(!NodeList.prototype.forEach)NodeList.prototype.forEach=Array.prototype.forEach;function Inherit(child,parent){Object.defineProperty(child.prototype=Object.create(parent.prototype),"constructor",{value:child,enumerable:false,writable:true})}if(localStorage){var Store={set:function(name,value,important){try{localStorage.setItem(name,value)}catch(e){return false}return true},get:function(name){return localStorage.getItem(name)},remove:function(name){localStorage.removeItem(name)}}}else{var Store={set:function(name,value,important){return false},get:function(name){return null},remove:function(name){}}}function TrackScrollResize(element,callback){var t=TrackScrollResize.tracking;if(callback){var n={element:element,callback:callback,height:element.getBoundingClientRect().height};if(TrackScrollResize.observer){TrackScrollResize.observer.observe(element);t.set(element,n)}else{t.push(n)}}else{if(TrackScrollResize.observer){TrackScrollResize.observer.unobserve(element);t["delete"](element)}else{for(var i=0;i<t.length;i++){if(t[i].element==element){t.splice(i,1);break}}}}}if(window.ResizeObserver){TrackScrollResize.tracking=new WeakMap;TrackScrollResize.observer=new ResizeObserver(function(events){var t=TrackScrollResize.tracking;events.forEach(function(event){var item=t.get(event.target);if(item){if(event.contentRect.width){var height=event.contentRect.height;if(height!=item.height){item.callback(item.height,event.contentRect.height);item.height=event.contentRect.height}}}})})}else{TrackScrollResize.tracking=[];TrackScrollResize.interval=window.setInterval(function(){TrackScrollResize.tracking.forEach(function(item){var newSize=item.element.getBoundingClientRect();if(newSize.width&&newSize.height!=item.height){item.callback(item.height,newSize.height);item.height=newSize.height}})},200)}var Entity=Object.create(null);with(Entity)(function($){"use strict";Object.assign(Entity,{categoryMap:null,gotNewCategory:false,process:function(resp){var users={};for(var key in resp){var type=keyType(key);if(type=="user"){processList(type,resp[key],users);resp[key].forEach(function(user){users[user.id]=user})}}if(resp.Ctree){processList("category",resp.Ctree,users)}for(var key in resp){var type=keyType(key);if(type!="user"&&key!="Ctree")processList(type,resp[key],users)}if(gotNewCategory)rebuildCategoryTree();resp.userMap=users},keyType:function(key){if(key[0]=="C")return"category";if(key[0]=="P")return"content";if(key[0]=="U")return"user";return key},processList:function(type,data,users){var proc=processItem[type];if(!proc){console.warn("recvd unknown type",type,data);return}if(type=="category")gotNewCategory=true;data.forEach(function(item,i,data){data[i]=proc(item,users);data[i].Type=type})},processItem:{activity:function(data,users){if(data.date)data.date=parseDate(data.date);if(data.type=="user")data.content=users[data.contentId];if(data.user)data.user=users[data.userId];return data},user:function(data,users){if(data.createDate)data.createDate=parseDate(data.createDate);data.name=data.name||data.username;return data},category:function(data,users){var cat=categoryMap[data.id];if(!cat){categoryMap[data.id]=cat=data}else{Object.assign(cat,data);data=cat}data=processItem.editable(data,users);return data},content:function(data,users){data=processItem.editable(data,users);if(data.parentId!=undefined)data.parent=categoryMap[data.parentId];return data},comment:function(data,users){data=processItem.editable(data,users);if(data.content){var m=decodeComment(data.content);data.content=m.t;data.meta=m}else{data.meta={}}return data},file:function(data,users){data=processItem.editable(data,users);return data},editable:function(data,users){if(data.editUserId)data.editUser=users[data.editUserId];if(data.createUserId)data.createUser=users[data.createUserId];if(data.editDate)data.editDate=parseDate(data.editDate);if(data.createDate)data.createDate=parseDate(data.createDate);return data},watch:function(data){return data}},rebuildCategoryTree:function(){gotNewCategory=false;for(var id in categoryMap)categoryMap[id].children=[];for(var id in categoryMap){var cat=categoryMap[id];var parent=categoryMap[cat.parentId]||categoryMap[0];if(cat.id!=0){parent.children.push(cat);cat.parent=parent}}},parseDate:function(str){if(!str)return new $.Date(0);var data=str.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:.\d+)?)/);if(!data)return new $.Date(0);var sec=$.Math.floor(+data[6]);var ms=+data[6]-sec;return new $.Date(Date.UTC(+data[1],+data[2]-1,+data[3],+data[4],+data[5],sec,ms))},decodeComment:function(content){var newline=content.indexOf("\n");try{var data=JSON.parse(newline>=0?content.substr(0,newline):content)}finally{if(data&&data.constructor==Object){if(newline>=0)data.t=content.substr(newline+1)}else data={t:String(content)};return data}},encodeComment:function(text,metadata){return JSON.stringify(metadata||{})+"\n"+text}});categoryMap={0:{name:"[root]",id:0,Type:"category",description:"",values:{}}}})(window);window.Req=Object.create(null);with(Req)(function($){"use strict";Object.assign(Req,{storageKey:"devauth",protocol:null,auth:null,onLogin:null,onLogout:null,server:null,uid:null,categoryTree:null,gotCategoryTree:false,onListeners:null,onMessages:null,onActivity:null,lpLastId:0,lpStatuses:{"-1":"online"},lpLastListeners:{"-1":{0:""}},lpProcessedListeners:{},lpCancel:function(){},lpRunning:false,me:null,rawRequest:function(url,method,callback,data,auth){var x=new $.XMLHttpRequest;x.open(method,url);var start=$.Date.now();x.onload=function(){var code=x.status;var type=x.getResponseHeader("Content-Type");if(/^application\/json(?!=\w)/.test(type)){try{var resp=JSON.parse(x.responseText)}catch(e){resp=null}}else{resp=x.responseText}if(code==200){callback(null,resp)}else if(code==408||code==204||code==524){callback("timeout",resp)}else if(code==429){$.setTimeout(function(){callback("rate",resp)},1e3)}else if(code==401||code==403){callback("auth",resp)}else if(code==404){callback("404",resp)}else if(code==400){try{resp=$.JSON.parse(resp)}catch(e){}callback("error",resp)}else{alert("Request failed! "+code+" "+url);console.log("REQUEST FAILED",x);try{resp=$.JSON.parse(resp)}catch(e){}callback("error",resp,code)}};x.onerror=function(){var time=$.Date.now()-start;if(time>18*1e3){callback("timeout")}else{$.alert("Request failed! "+url);$.console.log("xhr onerror");callback("fail")}};x.setRequestHeader("Cache-Control","no-cache, no-store, must-revalidate");x.setRequestHeader("Pragma","no-cache");if(auth)x.setRequestHeader("Authorization","Bearer "+auth);if(data){if(data&&data.constructor==Object){x.setRequestHeader("Content-Type","application/json;charset=UTF-8");x.send(JSON.stringify(data))}else{x.send(data)}}else{x.send()}return x},queryString:function(obj){if(!obj)return"";var items=[];for(var key in obj){var val=obj[key];if(typeof val!="undefined"){var item=$.encodeURIComponent(key)+"=";if(val instanceof $.Array){for(var i=0;i<val.length;i++){items.push(item+$.encodeURIComponent(val[i]))}}else{items.push(item+$.encodeURIComponent(val))}}}if(items.length)return"?"+items.join("&");else return""},request:function(url,method,callback,data){return rawRequest(server+"/"+url,method,function(e,resp){if(e=="auth")logOut();else callback(e,resp)},data,auth)},logOut:function(){$.Store.remove(storageKey);auth=null;onLogout()},gotAuth:function(newAuth){try{var newUid=Number($.JSON.parse($.atob(newAuth.split(".")[1])).uid)}catch(e){logOut();return false}auth=newAuth;uid=newUid;onLogin();return true},authenticate:function(username,password,callback){return request("User/authenticate","POST",function(e,resp){if(!e){gotAuth(resp);$.Store.set(storageKey,resp,true)}callback(e,resp)},{username:username,password:password})},tryLoadCachedAuth:function(){var auth=$.Store.get(storageKey);if(auth)var ok=gotAuth(auth);if(!ok)onGuestLoad();return ok},register:function(username,password,email,callback){return request("User/register","POST",callback,{username:username,password:password,email:email})},confirmRegister:function(key,callback){return request("User/register/confirm","POST",callback,{confirmationKey:key})},sendEmail:function(email,callback){return request("User/register/sendemail","POST",callback,{email:email})},read:function(requests,filters,callback,needCategories){var query={};query.requests=requests.map(function(req){if(typeof req=="string")return req;else for(var type in req)return type+"-"+JSON.stringify(req[type])});Object.assign(query,filters);needCategories=needCategories&&!gotCategoryTree;if(needCategories)query.requests.push("category~Ctree");return request("Read/chain"+queryString(query),"GET",function(e,resp){if(!e){handle(resp);if(needCategories)gotCategoryTree=true}callback(e,resp)})},listen:function(requests,filters,callback){var $=this;var query={};requests.forEach(function(req){for(var type in req){query[type]=JSON.stringify(req[type]);break}});Object.assign(query,filters);return request("Read/listen"+queryString(query),"GET",function(e,resp){if(!e)handle(resp.chains);callback(e,resp)})},handle:function(resp){Entity.process(resp)},getMe:function(callback){return request("User/me","GET",function(e,resp){if(!e){var l=[resp];Entity.processList("user",l,{});callback(l[0])}else{callback(null)}})},setBasic:function(data,callback){return request("User/basic","PUT",callback,data)},uploadFile:function(file,callback){var form=new FormData;form.append("file",file);request("File","POST",function(e,resp){if(e)callback(null);else{var l=[resp];Entity.processList("file",l,{});callback(l[0])}},form)},toggleHiding:function(id,callback){return getMe(function(me){if(me){var hiding=me.hidelist;arrayToggle(hiding,id);setBasic({hidelist:hiding},function(){callback(hiding)})}else callback(null)})},getCategories:function(callback){return read([],{},callback,true)},getUserView:function(id,callback){if(typeof id=="number")var userSearch={ids:[id],limit:1};else var userSearch={usernames:[id],limit:1};return read([{user:userSearch},{"content.0id$createUserIds~Puserpage":{type:"@user.page",limit:1}},{"activity.0id$userIds":{limit:20,reverse:true}},{"commentaggregate.0id$userIds":{limit:100,reverse:true}},"content.2contentId.3id"],{},function(e,resp){console.log(resp);if(!e){var user=resp.user[0];if(user){callback(user,resp.Puserpage[0],resp.activity,resp.commentaggregate,resp.content)}else{callback(null)}}else{callback(null)}},true)},getFileView:function(query,page,callback){var $=this;query.limit=20;query.skip=page*query.limit;query.reverse=true;return $.read([{file:query},"user.0createUserId"],{},function(e,resp){if(!e)callback(resp.file);else callback(null)},false)},getChatView:function(id,callback){return read([{content:{ids:[id]}},{comment:{parentIds:[id],limit:20,reverse:true}},"user.0createUserId.0editUserId.1createUserId.1editUserId"],{content:"name,parentId,type,createUserId,editUserId,createDate,editDate,permissions,id"},function(e,resp){if(!e){if(resp.content[0]){resp.comment.reverse();callback(resp.content[0],resp.comment)}else callback(null)}},true)},getUsersView:function(callback){return read(["user"],{},function(e,resp){if(!e){callback(resp.user)}},true)},setVote:function(id,state,callback){return request("Vote/"+id+"/"+(state||"delete"),"POST",callback)},getPageView:function(id,callback){return read([{content:{ids:[+id],includeAbout:true}},"user.0createUserId.0editUserId"],{},function(e,resp){if(!e&&resp.content[0])callback(resp.content[0]);else callback(null)},true)},getCategoryView:function(id,callback){var search={parentIds:[id],limit:10,sort:"editDate",reverse:true};return read([{"category~Cmain":{ids:[id]}},{content:search},{category:{parentIds:[id]}},"content.0values_pinned~Ppinned","user.1createUserId.3createUserId"],{content:"id,name,parentId,createUserId,editDate,permissions",user:"id,username,avatar"},function(e,resp){if(!e){if(id==0)var category=$.Entity.categoryMap[0];else category=resp.Cmain[0];callback(category,resp.category,resp.content,resp.Ppinned)}else{callback(null)}},true)},sendMessage:function(room,message,meta,callback){return request("Comment","POST",callback,{parentId:room,content:JSON.stringify(meta)+"\n"+message})},doListenInitial:function(callback){return read([{comment:{reverse:true,limit:20}},{activity:{reverse:true,limit:10}},{activityaggregate:{reverse:true,limit:10}},"content.0parentId.1contentId.0id","category.1contentId","user.0createUserId.1userId.2userIds"],{content:"id,createUserId,name,permissions"},callback)},doListen:function(lastId,statuses,lastListeners,getMe,callback){var actions={lastId:lastId,statuses:statuses,chains:["comment.0id",'activity.0id-{"includeAnonymous":true}',"watch.0id","content.1parentId.2contentId.3contentId","user.1createUserId.2userId.1editUserId.2contentId","category.2contentId"]};if(getMe)var listeners={lastListeners:lastListeners,chains:["user.0listeners",'user~Ume-{"ids":['+ +uid+'],"limit":1}']};else listeners={lastListeners:lastListeners,chains:["user.0listeners"]};return listen([{actions:actions},{listeners:listeners}],{content:"id,createUserId,name,permissions"},callback)},lpRefresh:function(){if(lpRunning){lpCancel();lpLoop()}},lpStart:function(callback){if(!lpRunning)lpLoop(callback)},handleOnListeners:function(listeners,users){var out={};for(var id in listeners){var list=listeners[id];var list2={};for(var uid in list)list2[uid]={user:users[uid],status:list[uid]};out[id]=list2}lpProcessedListeners=out;onListeners(out)},lpProcess:function(resp){if(resp.listeners){handleOnListeners(resp.listeners,resp.chains.userMap)}if(resp.chains){if(resp.chains.comment)onMessages(resp.chains.comment);if(resp.chains.commentdelete)onMessages(resp.chains.commentdelete);if(resp.chains.activity)onActivity(resp.chains.activity)}},lpLoop:function(noCancel){lpRunning=true;var cancelled;var x=doListen(lpLastId,lpStatuses,lpLastListeners,noCancel,function(e,resp){if(noCancel)noCancel(e,resp);if(cancelled){console.log("OH HECK");return}try{lpLastId=resp.lastId;if(resp.listeners)lpLastListeners=resp.listeners;lpProcess(resp)}catch(e){console.error(e)}if(!e||e=="timeout"||e=="rate"){var t=setTimeout(function(){if(cancelled)return;lpLoop()},0);lpCancel=function(){cancelled=true;lpRunning=false;clearTimeout(t)}}else{alert("LONG POLLER FAILED:"+resp);console.log("LONG POLLER FAILED",e,resp)}});lpCancel=function(){if(noCancel)return;cancelled=true;lpRunning=false;x.abort()}},lpSetListening:function(ids){var newListeners={"-1":lpLastListeners[-1]};ids.forEach(function(id){newListeners[id]=lpLastListeners[id]||{0:""}});lpLastListeners=newListeners},fileURL:function(id,query){if(query)return server+"/File/raw/"+id+"?"+query;return server+"/File/raw/"+id},lpSetStatus:function(statuses){for(var id in statuses){var status=statuses[id];lpStatuses[id]=status;if(!lpLastListeners[id])lpLastListeners[id]={};lpLastListeners[id][uid]=status;if(!lpProcessedListeners[id])lpProcessedListeners[id]={};lpProcessedListeners[id][uid]={user:me,status:status}}onListeners(lpProcessedListeners);lpRefresh()}});function arrayToggle(array,value){var i=array.indexOf(value);if(i<0)array.push(value);else array.splice(i,1)}if($.location.protocol=="http:")protocol="http:";else protocol="https:";server=protocol+"//newdev.smilebasicsource.com/api"})(window);var Draw=Object.create(null);with(Draw)(function($){"use strict";Object.assign(Draw,{avatarURL:function(user,params){if(!user||!user.avatar)return"resource/avatar.png";return Req.fileURL(user.avatar,params)},largeIcon:function(entity){var element=document.createElement("img");if(entity.Type=="user")element.src=avatarURL(entity,"size=400&crop=true");else element.src="resource/unknown.png";return entity},iconTitle:function(entity,reverse){var element=document.createDocumentFragment();if(reverse){element.appendChild(title(entity));element.appendChild(icon(entity))}else{element.appendChild(icon(entity));element.appendChild(title(entity))}return element},entityLink:function(entity){var path=Nav.entityPath(entity);if(path)var element=Nav.link(path);else element=document.createElement("span");return element},pageBar:function(page){var bar=entityTitleLink(page);if(page.createUser){var usr=entityTitleLink(page.createUser,true);usr.className+=" rightAlign";bar.appendChild(usr)}return bar},entityTitleLink:function(entity,reverse){var element=entityLink(entity);var icon=iconTitle(entity,reverse);element.appendChild(icon);return element},title:function(entity){return textItem(entity.name)},textItem:function(text){var element=document.createElement("span");element.textContent=text;element.className="textItem pre";return element},iconURL:function(entity){if(entity.Type=="user"){return}else if(entity.Type=="category")return"resource/category.png";else if(entity.Type=="content"){if(!hasPerm(entity.permissions,0,"r"))return"resource/hiddenpage.png";return"resource/page.png"}return"resource/unknown.png"},userListAvatar:function(status){var a=linkAvatar(status.user);if(status.status=="idle")a.className+=" status-idle";return a},sidebarDebug:function(text){var x=document.createElement("div");x.className="debugMessage pre";x.textContent=text;return x},linkAvatar:function(user){var a=entityLink(user);a.appendChild(avatar(user));a.title=user.username;return a},avatar:function(user){var element=document.createElement("img");element.className+="item avatar";element.src=avatarURL(user,"size=120&crop=true");return element},fileThumbnail:function(file,onclick){var div=document.createElement("div");div.className="fileThumbnail item";div.setAttribute("data-id",file.id);var img=document.createElement("img");img.src=Req.fileURL(file.id,"size=50");img.alt=file.name;img.title=file.name;div.appendChild(img);if(onclick){div.onclick=function(e){onclick(file,e)}}return div},icon:function(entity){var element;if(entity.Type=="user"){element=document.createElement("img");element.className+="item icon avatar";element.src=avatarURL(entity,"size=120&crop=true")}else{element=document.createElement("span");element.setAttribute("role","img");element.className="item icon iconBg";if(entity.Type=="category")element.style.backgroundImage="url('resource/category.png')";else if(entity.Type=="content"){if(!hasPerm(entity.permissions,0,"r"))element.style.backgroundImage="url('resource/hiddenpage.png')";else element.style.backgroundImage="url('resource/page.png')"}else element.style.backgroundImage="url('resource/unknown.png')"}return element},markup:function(page){if(page.values)var lang=page.values.markupLang;return Parse.parseLang(page.content,lang,true)},titlePath:function(path){var element=document.createDocumentFragment();if(!path)return element;path.forEach(function(item,i,path){if(item){var link=Nav.link(item[0]);link.textContent=item[1];link.className="textItem pre";element.appendChild(link)}if(i<path.length-1){var slash=document.createElement("span");slash.textContent="/";slash.className="pathSeparator textItem";element.appendChild(slash)}});return element},messageBlock:function(comment){var user=comment.createUser;var date=comment.createDate;var div=document.createElement("div");div.className="message";var timeStamp=document.createElement("time");timeStamp.className="messageTime";timeStamp.setAttribute("datetime",date+"");timeStamp.textContent=timeString(date);div.appendChild(timeStamp);var av=+comment.meta.a;if(av)user=Object.create(user,{avatar:{value:av}});div.appendChild(avatar(user));var name=document.createElement("span");name.className="username";name.textContent=user.name+":";div.appendChild(name);var contentBox=document.createElement("div");contentBox.className="messageContents";div.appendChild(contentBox);return[div,contentBox]},messagePart:function(comment){var element=document.createElement("p");element.className="markup-root messagePart";element.setAttribute("data-id",comment.id);element.setAttribute("tabindex","0");var contents=Parse.parseLang(comment.content,comment.meta.m,false);if(comment.createDate.getTime()!=comment.editDate.getTime())element.className+=" edited";element.appendChild(contents);return element},timeString:function(date){if(new Date-date>1e3*60*60*12){var options={year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}}else{options={hour:"2-digit",minute:"2-digit"}}return date.toLocaleString([],options)},button:function(){var container=document.createElement("div");container.className="buttonContainer";var button=document.createElement("button");container.appendChild(button);return[container,button]},navButtons:function(callback){var prev=button();prev[0].className+=" item";var next=button();next[0].className+=" item";var page=textItem();prev[1].textContent="<";next[1].textContent=">";page.textContent=1;var e=document.createDocumentFragment();e.appendChild(prev[0]);e.appendChild(next[0]);e.appendChild(page);return e},authorBox:function(page){var element=document.createDocumentFragment();if(!page)return element;element.appendChild(pageEditedTime("Author",page.createDate));element.appendChild(entityTitleLink(page.createUser));if(page.editUserId!=page.createUserId){element.appendChild(pageEditedTime("Edited by",page.editDate));element.appendChild(entityTitleLink(page.editUser))}else if(page.createDate!=page.editDate){element.appendChild(pageEditedTime("Edited",page.editDate))}return element},pageEditedTime:function(label,time){var b=document.createElement("span");b.className="item";var a=document.createElement("div");a.className="half";a.textContent=label;b.appendChild(a);a=timeAgo(time);a.className+=" half";b.appendChild(a);return b},timeAgo:function(time){var t=document.createElement("time");t.setAttribute("dateTime",time.toISOString());t.textContent=timeAgoString(time);t.title=""+time;return t},timeAgoString:function(date){var seconds=Math.floor((Date.now()-date.getTime())/1e3);var interval=Math.floor(seconds/31536e3);if(interval>=1)return interval+" years ago";interval=Math.round(seconds/2592e3);if(interval>=1)return interval+" months ago";interval=Math.round(seconds/86400);if(interval>=1)return interval+" days ago";interval=Math.round(seconds/3600);if(interval>=1)return interval+" hours ago";interval=Math.round(seconds/60);if(interval>=1)return interval+" minutes ago";if(seconds<0)return" IN THE FUTURE?";return Math.round(seconds)+" seconds ago"}});function hasPerm(perms,id,perm){return perms&&perms[id]&&perms[id].indexOf(perm)!=-1}})(window);var View=Object.create(null);with(View)(function($){"use strict";Object.assign(View,{cancelRequest:null,currentView:null,initDone:false,runOnLoad:[],realTitle:null,faviconElement:null,views:{"":{className:"homeMode",render:function(){var text="Welcome to SmileBASIC Source 2!";setTitle(text)}},test:{init:function(){$testButton.onclick=function(){var c=$testTextarea.value;$testOut.textContent="Starting...";try{var res=eval(c);$testOut.textContent="Finished:\n"+res}catch(e){$testOut.textContent="Error:\n"+e}}},className:"testMode",render:function(){setTitle("Testing")}},user:{start:function(id,query,render){if(typeof id=="string"&&id[0]=="@")id=id.substr(1);return $.Req.getUserView(id,render)},className:"userMode",render:function(user,userpage,activity,ca,content){if(user.id==Req.uid)flag("myUserPage",true);setEntityTitle(user);$userPageAvatar.src=Draw.avatarURL(user,"size=400&crop=true");if(userpage)$userPageContents.replaceChildren(Draw.markup(userpage));else $userPageContents.replaceChildren()},cleanUp:function(){$userPageAvatar.src="";$userPageContents.replaceChildren()}},users:{start:function(id,query,render){return $.Req.getUsersView(render)},className:"membersMode",render:function(users){setTitle("Users");users.forEach(function(user){var bar=Draw.entityTitleLink(user);bar.className+=" linkBar bar rem2-3";$memberList.appendChild(bar)})},cleanUp:function(){$memberList.replaceChildren()},init:function(){var nav=$memberNav;nav.appendChild(Draw.navButtons())}},category:{start:function(id,query,render){return $.Req.getCategoryView(id,render)},className:"categoryMode",render:function(category,cats,pages,pinned){setEntityTitle(category);setEntityPath(category);$categoryDescription.replaceChildren(Parse.parseLang(category.description,category.values.markupLang));$categoryCategories.replaceChildren();Nav.link("editcategory/"+category.id,$editButton);category.children.forEach(function(child){var bar=Draw.entityTitleLink(child);bar.className+=" linkBar bar rem2-3";$categoryCategories.appendChild(bar)});pinned.forEach(function(page){var bar=Draw.pageBar(page);bar.className+=" linkBar bar rem2-3";$categoryCategories.appendChild(bar)});pages.forEach(function(page){var bar=Draw.pageBar(page);bar.className+=" linkBar bar rem2-3";$categoryPages.appendChild(bar)});$.Nav.link("editpage?cid="+category.id,$createPage);if(/u/.test(category.myPerms))flag("canEdit",true)},cleanUp:function(){$categoryCategories.replaceChildren();$categoryPages.replaceChildren();$categoryDescription.replaceChildren();flag("canEdit",false)},init:function(){var nav=$categoryNav;nav.appendChild(Draw.navButtons())}},pages:{redirect:"page"},template:{start:function(id,query,render){render(1,2,3,4)},className:"templateMode",render:function(a,b,c,d){},cleanUp:function(){},init:function(){}}},errorView:{className:"errorMode",render:function(message,error){setTitle(message);if(error)$errorMessage.textContent=error+"\n"+error.stack;else $errorMessage.textContent=""},cleanUp:function(){$errorMessage.replaceChildren()}},getView:function(name){var view=views[name];while(view&&view.redirect)view=views[view.redirect];return view},setEntityTitle:function(entity){$pageTitle.replaceChildren(Draw.iconTitle(entity));$.document.title=entity.name;realTitle=entity.name;changeFavicon(false)},setTitle:function(text){$pageTitle.textContent=text;$.document.title=text;realTitle=text;changeFavicon(false)},setPath:function(path){$path.replaceChildren(Draw.titlePath(path))},setEntityPath:function(page){if(page.Type=="category")var node=page;else node=page.parent;var path=[];while(node){path.unshift([Nav.entityPath(node),node.name]);node=node.parent}if(page.Type=="category")path.push(null);else path.push([Nav.entityPath(page),page.name]);setPath(path)},loadStart:function(){flag("loading",true)},loadEnd:function(){flag("loading",false)},flags:{},flag:function(flag,state){if(!flags[flag]!=!state){if(state)flags[flag]=true;else delete flags[flag];var cls="";for(flag in flags)cls+=" f-"+flag;$.document.documentElement.className=cls}},updateUserAvatar:function(user){ChatRoom.updateUserAvatar(user);if(user.id==Req.uid)updateMyUser(user)},updateMyUser:function(user){if(user.id!=Req.uid)return;Req.me=user;$loggedIn.replaceChildren(Draw.entityTitleLink(user,true))},handleView:function(type,id,query,callback){if(cancelRequest){cancelRequest();cancelRequest=null}var view=getView(type);function cleanUp(){if(currentView&&currentView.cleanUp){try{currentView.cleanUp(type,id,query)}catch(e){console.error("error in cleanup function",e)}finally{currentView=null}}}var cancelled=false;if(!view){whenPageLoaded(function(){cleanUp();errorRender('Unknown page type: "'+type+'"')})}else if(view.start){whenPageLoaded(function(){loadStart()});try{var xhr=view.start(id,query,function(ok){var args=arguments;whenPageLoaded(function(){if(cancelled)return;cleanUp();if(!ok){if(ok==false)var msg="error 1";else var msg="content not found?";errorRender(msg)}else{currentView=view;try{view.render.apply(null,args);after()}catch(e){errorRender("render failed",e)}}loadEnd()})},function(){whenPageLoaded(quick)})}catch(e){errorRender("render failed 1",e);loadEnd()}}else{whenPageLoaded(function(){loadStart();quick(view.render)})}function whenPageLoaded(callback){if(cancelled)return;if(initDone)callback();else{console.log("deferring render");runOnLoad.push(callback)}}function quick(ren){cleanUp();currentView=view;try{ren(id,query);after()}catch(e){errorRender("render failed",e)}loadEnd()}function errorRender(message,error){cleanUp();currentView=view=errorView;view.render(message,error);after()}cancelRequest=function(){loadEnd();if(xhr&&xhr.abort){xhr.abort()}cancelled=true};function after(){$.document.body.className=view.className;callback&&callback()}},onLoad:function(){document.querySelectorAll("a[data-static-path]").forEach(function(elem){Nav.link(elem.getAttribute("data-static-path"),elem)});document.querySelectorAll("button").forEach(function(button){var container=document.createElement("div");container.className="buttonContainer";button.parentNode.replaceChild(container,button);container.className+=" "+button.className;button.className="";container.appendChild(button)});for(var n in views){views[n].name=n;if(views[n].init)views[n].init()}initDone=true;runOnLoad.forEach(function(f){f()});runOnLoad=null;document.addEventListener("videoclicked",function(e){imageFocusClickHandler(e.target)});document.onmousedown=function(e){if(!e.button&&e.target)imageFocusClickHandler(e.target)};var embiggenedImage;function imageFocusClickHandler(element){if(element.hasAttribute("shrink")){if(embiggenedImage&&embiggenedImage==element){embiggenedImage.removeAttribute("bigImage");embiggenedImage=null}else if(element!=embiggenedImage){if(embiggenedImage)embiggenedImage.removeAttribute("bigImage");element.setAttribute("bigImage","");embiggenedImage=element}}else if(!(element instanceof HTMLTextAreaElement)){if(embiggenedImage&&element!=embiggenedImage){embiggenedImage.removeAttribute("bigImage");embiggenedImage=null}}}Sidebar.onLoad()},addView:function(name,data){data.name=name;views[name]=data;if(initDone&&data.init)data.init()},attachPaste:function(callback){document.addEventListener("paste",function(event){var data=event.clipboardData;if(data&&data.files){var file=data.files[0];if(file&&/^image\//.test(file.type))callback(file)}})},attachResize:function(element,tab,horiz,dir,save){var startX,startY,held,startW,startH,size=null;function getPos(e){if(e.touches)return{x:e.touches[0].pageX,y:e.touches[0].pageY};else return{x:e.clientX,y:e.clientY}}function down(e){tab.setAttribute("dragging","");var pos=getPos(e);startX=pos.x;startY=pos.y;startW=element.offsetWidth;startH=element.offsetHeight;held=true}function up(){held=false;tab.removeAttribute("dragging");if(save&&size!=null)Store.set(save,size)}function move(e){if(!held)return;var pos=getPos(e);if(horiz){var vx=(pos.x-startX)*dir;size=Math.max(0,startW+vx);element.style.width=size+"px"}else{var vy=(pos.y-startY)*dir;size=Math.max(0,startH+vy);element.style.height=size+"px"}}tab.addEventListener("mousedown",down);document.addEventListener("mouseup",up);document.addEventListener("mousemove",move);tab.addEventListener("touchstart",down);document.addEventListener("touchend",up);document.addEventListener("touchmove",move);if(save){size=Store.get(save);if(size){size=Math.max(0,+size);if(horiz)element.style.width=size+"px";else element.style.height=size+"px"}}},titleNotification:function(text,icon){if(text==false){$.document.title=realTitle;changeFavicon(false);return}$.document.title=text;changeFavicon(icon||false)},changeFavicon:function(src){if(!faviconElement){if(src==false)return;faviconElement=document.createElement("link");faviconElement.rel="icon";document.head.appendChild(faviconElement)}else if(faviconElement.href==src)return;if(src==false)src="resource/icon16.png";faviconElement.href=src}})})(window);with(View)(function($){"use strict";addView("settings",{className:"settingsMode",render:function(){setTitle("Account Settings")},init:function(){$loginForm.login.onclick=function(e){e.preventDefault();Req.authenticate($loginForm.username.value,$loginForm.password.value,function(e,resp){})};$logOut.onclick=function(e){Req.logOut()};$registerForm.$registerButton.onclick=function(e){e.preventDefault();registerError("Registering...");var data=readRegisterFields();if(data.error){registerError(data.error);return}Req.register(data.username,data.password,data.email,function(e,resp){console.log(resp);if(!e){sendConfirmationEmail()}else{if(e=="error"&&resp){registerError(resp.errors,"Registration failed:")}else if(e=="rate"){registerError("slow down!")}else{registerError("unknown error")}}})};$resendEmail.onclick=function(e){e.preventDefault();sendConfirmationEmail()};$registerConfirm.onclick=function(e){e.preventDefault();registerError("Confirming...");Req.confirmRegister($emailCode.value,function(e,resp){if(!e){registerError("Registration Complete")}else{registerError(resp,"Confirmation failed:")}})}}});function registerError(message,title){var text="";if(message==undefined)text="";else if(message instanceof Array)text=message.join("\n");else if(typeof message=="string"){text=message}else{for(var key in message){text+=key+": "+message[key]+"\n"}}if(title)text=title+"\n"+text;$registerError.textContent=text}function readRegisterFields(){var data={username:$registerForm.username.value,password:$registerForm.password.value,email:$registerForm.email.value};data.error={};if(data.password.length<8)data.error.password="Password too short";if(data.username.length<2)data.error.username="Username too short";if(data.username.length>20)data.error.username="Username too long";if(data.password!=$registerForm.password2.value)data.error.password2="Passwords don't match";if(data.email!=$registerForm.email2.value)data.error.email2="Emails don't match";if(!Object.keys(data.error).length)data.error=null;return data}function sendConfirmationEmail(){var email=$registerForm.email.value;if(!email){registerError({email:"No email"})}else{registerError("Sending email...");Req.sendEmail(email,function(e,resp){if(!e){registerError("Confirmation email sent")}else if(e=="error"){registerError({email:resp},"Failed to send confirmation email:")}else if(e=="rate"){registerError("Slow down!")}else{registerError("unknown error")}})}}})(window);function Scroller(outer,inner){this.outer=outer;this.inner=inner;this.animationId=null;this.atBottom=true;var $=this;outer.addEventListener("scroll",function(e){if($.ignoreScroll){$.ignoreScroll=false;return}if($.animationId)$.cancelAutoScroll();$.atBottom=$.scrollBottom<$.outer.clientHeight/4},{passive:true});function onResize(){if($.atBottom&&!$.animationId)$.autoScroll(true)}TrackScrollResize(this.outer,onResize);TrackScrollResize(this.inner,onResize)}Object.defineProperty(Scroller.prototype,"scrollBottom",{get:function(){var parent=this.outer;return parent.scrollHeight-parent.clientHeight-parent.scrollTop},set:function(value){var parent=this.outer;value=Math.floor(value*window.devicePixelRatio)/window.devicePixelRatio;parent.scrollTop=parent.scrollHeight-parent.clientHeight-value}});Scroller.prototype.autoScroll=function(instant){if(!window.requestAnimationFrame||instant){this.ignoreScroll=true;this.scrollBottom=0;this.atBottom=true}else{if(!this.animationId){this.animationId=null;var now=performance.now();this.animationStart=now-1e3/60;this.autoScrollAnimation(now)}}};Scroller.prototype.cancelAutoScroll=function(){if(this.animationId){window.cancelAnimationFrame(this.animationId);this.animationId=false}};Scroller.prototype.autoScrollAnimation=function(time){var dt=(time-this.animationStart)/(1e3/60);this.animationStart=time;this.ignoreScroll=true;var expect=Math.floor(this.scrollBottom*Math.pow(.75,dt));this.scrollBottom=expect;this.atBottom=true;if(this.scrollBottom<=0){this.animationId=null;this.atBottom=true;return}var $=this;this.animationId=window.requestAnimationFrame(function(time){if($.scrollBottom==expect)$.autoScrollAnimation(time)})};Scroller.prototype.handlePrint=function(callback,autoscroll){var should=autoscroll&&this.atBottom;var elem=callback();if(elem)this.inner.appendChild(elem);if(should)this.autoScroll()};Scroller.prototype.destroy=function(){TrackScrollResize(this.inner,null);TrackScrollResize(this.outer,null)};function ChatRoom(id,page){var old=ChatRoom.rooms[id];if(old)return old;var $=this;this.id=id;this.userList={};if(id==-1){this.userListElem=$sidebarUserList;return}this.status="active";this.page=page;this.lastUid=NaN;this.lastBlock=null;this.lastTime=0;this.userListElem=document.createElement("div");this.userListElem.className="bar rem2-3 userlist";this.messagePane=document.createElement("div");this.messagePane.className="chatScroller scrollOuter";this.messagePane.style.display="none";this.userListElem.style.display="none";$chatPane.appendChild(this.userListElem);$chatPane.appendChild(this.messagePane);this.messageList=document.createElement("div");this.messageList.className="scrollInner";this.messagePane.appendChild(this.messageList);this.visible=false;this.scroller=new Scroller(this.messagePane,this.messageList);ChatRoom.addRoom(this)}ChatRoom.generateStatus=function(){var status={};for(var id in ChatRoom.rooms){status[id]=ChatRoom.rooms[id].status}status[-1]=ChatRoom.global.status;return status};ChatRoom.updateStatus=function(){Req.lpSetStatus(ChatRoom.generateStatus())};ChatRoom.rooms={};ChatRoom.updateUserAvatar=function(user){for(var id in ChatRoom.rooms){ChatRoom.rooms[id].updateUserAvatar(user)}if(ChatRoom.global)ChatRoom.global.updateUserAvatar(user)};ChatRoom.prototype.toggleHiding=function(callback){Req.toggleHiding(this.id,callback||function(){})};ChatRoom.prototype.updateUserAvatar=function(user){for(var uid in this.userList){if(this.userList[uid].user.id==user.id){this.userList[uid].user=user;this.updateUserList(this.userList);break}}};Object.defineProperty(ChatRoom.prototype,"scrollBottom",{get:function(){var parent=this.messagePane;return parent.scrollHeight-parent.clientHeight-parent.scrollTop},set:function(value){var parent=this.messagePane;value=Math.floor(value*window.devicePixelRatio)/window.devicePixelRatio;parent.scrollTop=parent.scrollHeight-parent.clientHeight-value}});ChatRoom.addRoom=function(room){ChatRoom.rooms[room.id]=room;ChatRoom.setViewing(Object.keys(ChatRoom.rooms))};ChatRoom.removeRoom=function(room){if(ChatRoom.currentRoom==room)ChatRoom.currentRoom=null;if(ChatRoom.rooms[room.id]==room)delete ChatRoom.rooms[room.id];ChatRoom.setViewing(Object.keys(ChatRoom.rooms))};ChatRoom.setViewing=function(ids){Req.lpSetListening(ids);Req.lpRefresh()};ChatRoom.updateUserLists=function(a){if(a[-1]){ChatRoom.global.updateUserList(a[-1])}for(var id in a){var room=ChatRoom.rooms[id];if(room)room.updateUserList(a[id])}};ChatRoom.displayMessages=function(comments){var displayedIn={};comments.forEach(function(comment){var room=ChatRoom.rooms[comment.parentId];if(room){room.displayMessage(comment);displayedIn[room.id]=true}})};ChatRoom.prototype.updateUserList=function(list){this.userList=list;var d=document.createDocumentFragment();for(var uid in list)d.appendChild(Draw.userListAvatar(list[uid]));this.userListElem.replaceChildren(d)};ChatRoom.prototype.displayInitialMessages=function(comments){var $=this;comments.forEach(function(comment){$.displayMessage(comment,false)});window.setTimeout(function(){$.scroller.autoScroll(true)},0)};ChatRoom.prototype.show=function(){var old=ChatRoom.currentRoom;if(old)old.hide();this.messagePane.style.display="";this.userListElem.style.display="";this.visible=true;ChatRoom.currentRoom=this};ChatRoom.prototype.hide=function(){if(this.pinned){this.messagePane.style.display="none";this.userListElem.style.display="none";if(ChatRoom.currentRoom==this)ChatRoom.currentRoom=null;this.visible=false}else this.destroy()};ChatRoom.prototype.destroy=function(){ChatRoom.removeRoom(this);this.userListElem.remove();this.messagePane.remove();this.userListElem=null;this.scoller.destroy();this.scoller=null;this.visible=false};ChatRoom.prototype.shouldScroll=function(){return this.scroller.atBottom};ChatRoom.prototype.displayMessage=function(comment,autoscroll){if(comment.deleted)return;var $=this;this.scroller.handlePrint(function(){var uid=comment.createUserId;if(!$.lastBlock||uid!=$.lastUid||comment.createDate-$.lastTime>1e3*60*5){$.lastBlock=Draw.messageBlock(comment);var ret=$.lastBlock[0]}$.lastBlock[1].appendChild(Draw.messagePart(comment));$.lastUid=uid;$.lastTime=comment.createDate;return ret},autoscroll!=false)};with(View)(function($){"use strict";var room;addView("chat",{start:function(id,query,render,quick){var room=ChatRoom.rooms[id];if(room){quick(function(){var page=room.page;Nav.link("page/"+page.id,$pagePageLink);setEntityTitle(page);setEntityPath(page);room.show()})}else{return $.Req.getChatView(id,render)}},className:"chatMode",render:function(page,comments){Nav.link("page/"+page.id,$pagePageLink);setEntityTitle(page);setEntityPath(page);room=new ChatRoom(page.id,page);room.displayInitialMessages(comments);room.show()},cleanUp:function(type){room.hide()},init:function(){$chatSend.onclick=function(){var msg=$chatTextarea.value;var room=ChatRoom.currentRoom;if(msg&&room){var meta={};var markup=$chatMarkupSelect.value;if(markup&&markup!="plaintext")meta.m=markup;if(Req.me)meta.a=Req.me.avatar;Req.sendMessage(room.id,msg,meta,function(){})}$chatTextarea.value=""};$chatTextarea.onkeypress=function(e){if(!e.shiftKey&&e.keyCode==13){e.preventDefault();$chatSend.onclick()}};ChatRoom.global=new ChatRoom(-1);$hideGlobalStatusButton.onclick=function(){if($hideGlobalStatusButton.disabled)return;$hideGlobalStatusButton.disabled=true;console.log($hideGlobalStatusButton.disabled);ChatRoom.global.toggleHiding(function(){$hideGlobalStatusButton.disabled=false})}}})})(window);with(View)(function($){"use strict";var currentPage;addView("page",{start:function(id,query,render){return $.Req.getPageView(id,render)},className:"pageMode",render:function(page){currentPage=page;Nav.link("chat/"+page.id,$pageChatLink);setEntityTitle(page);setEntityPath(page);$pageContents.replaceChildren(Parse.parseLang(page.content,page.values.markupLang));Nav.link("editpage/"+page.id,$editButton);if(/u/.test(page.myPerms))flag("canEdit",true);["b","o","g"].forEach(function(vote){$["$voteCount_"+vote].textContent=page.about.votes[vote].count;var button=$["$voteButton_"+vote];if(page.about.myVote==vote)button.setAttribute("data-selected","true");else button.removeAttribute("data-selected")});$authorBox.replaceChildren(Draw.authorBox(page))},init:function(){var voteBtns=[$voteButton_b,$voteButton_o,$voteButton_g];var voteCounts=[$voteCount_b,$voteCount_o,$voteCount_g];var voteBlock;voteBtns.forEach(function(button,buttoni){button.onclick=function(e){if(voteBlock||!Req.auth||!currentPage)return;var selected=button.getAttribute("data-selected");var vote=!selected?button.getAttribute("data-vote"):null;voteBlock=true;Req.setVote(currentPage.id,vote,function(e,resp){voteBlock=false;if(!e){voteBtns.forEach(function(btn,i){if(btn!=button||selected){if(btn.getAttribute("data-selected")!=null){voteCounts[i].textContent=+voteCounts[i].textContent-1}btn.removeAttribute("data-selected")}});if(!selected){button.setAttribute("data-selected","true");voteCounts[buttoni].textContent=+voteCounts[buttoni].textContent+1}}})}})},cleanUp:function(){$pageContents.replaceChildren();flag("canEdit",false)}})})(window);with(View)(function($){"use strict";addView("search",{init:function(){},className:"searchMode",render:function(id,query,render){setTitle("Search")},cleanUp:function(){$searchResults.replaceChildren()}})})(window);with(View)(function($){"use strict";addView("images",{init:function(){var nav=$fileNav;nav.replaceChildren(Draw.navButtons())},start:function(id,query,render){var page=+query.page||0;return Req.getFileView({},page,render)},className:"fileMode",render:function(files){setTitle("Files");files.forEach(function(file){$fileBox.appendChild(Draw.fileThumbnail(file,selectFile))})},cleanUp:function(){$fileBox.replaceChildren()}});function selectFile(file){$fileName.value=file.name;$filePermissions.value=JSON.stringify(file.permissions);$fileValues.value=JSON.stringify(file.values);$fileUser.textContent=file.createUser.username;$fileView.src="";$fileView.src=Req.fileURL(file.id);flag("fileSelected",true);flag("canEdit",/u/.test(file.myPerms))}})(window);var Sidebar=Object.create(null);with(Sidebar)(function($){"use strict";Object.assign(Sidebar,{selectedFile:null,scroller:null,prePrint:[],onLoad:function(){$openSidebar.onclick=$closeSidebar.onclick=toggle;View.attachResize($sidebar,$sidebarResize,true,-1,"sidebarWidth");View.attachResize($sidebarTop,$sidebarResize,false,1,"sidebarPinnedHeight");View.flag("sidebar",true);View.attachPaste(function(file){fileUploaded(file)});$imageUpload.onchange=function(e){var file=this.files[0];if(file)fileUploaded(file)};$fileCancel.onclick=$fileDone.onclick=fileCancel;$fileUpload.onclick=function(){if(selectedFile){Req.uploadFile(selectedFile,function(file){if(file){View.flag("sidebarUploaded",true);$fileView.src="";$fileView.src=Req.fileURL(file.id);$fileURL.value=Req.fileURL(file.id)}else{}})}};$fileURL.onclick=function(){$fileURL.select()};scroller=new Scroller($sidebarActivityOuter,$sidebarActivity);prePrint.forEach(function(x){print(x)});prePrint=null},print:function(text){if(scroller)scroller.handlePrint(function(){return Draw.sidebarDebug(text)},true);else prePrint.push(text)},fileCancel:function(){selectedFile=null;View.flag("sidebarFile",false);View.flag("sidebarUploaded",false);cleanUp()},cleanUp:function(){selectedFile=null;$fileView.src=""},fileUploaded:function(file){View.flag("sidebarUploaded",false);View.flag("sidebarFile",true);$fileView.src="";$fileView.src=URL.createObjectURL(file);selectedFile=file},toggle:function(){var fullscreen=isFullscreen();if(fullscreen){View.flag("mobileSidebar",!View.flags.mobileSidebar)}else{View.flag("sidebar",!View.flags.sidebar);Store.set("sbs-sidebar",!!View.flags.sidebar)}},isFullscreen:function(){return!$.matchMedia||$.matchMedia("(max-width: 700px)").matches}})})(window);var Nav=Object.create(null);with(Nav)void function($){"use strict";Object.assign(Nav,{currentPath:null,initialPop:false,init:false,entityPath:function(entity){if(!entity)return;if(entity.Type=="user")return"user/"+entity.id;if(entity.Type=="content")return"page/"+entity.id;if(entity.Type=="category")return"category/"+entity.id;return"unknown/"+entity.id},link:function(path,element){path=String(path);element=element||$.document.createElement("a");element.href="?"+path;element.onclick=function(e){e.preventDefault();e.stopPropagation();go(path)};return element},go:function(path){currentPath=path;$.history.pushState(null,"","?"+path);render(path)},initial:function(){if(init||initialPop)return;initialPop=true;init=true;updateFromLocation()},updateFromLocation:function(){var path=$.location.search.substr(1);currentPath=path;render(path)},parsePath:function(path){var a=path.split1("#");var b=a[0].split1("?");var base=b[0];var fragment=a[1];var query=b[1];var queryVars={};if(query){query.split("&").forEach(function(item){item=item.split1("=");var name=decodeURIComponent(item[0].trim());if(item[1]==null)queryVars[name]=true;else queryVars[name]=decodeURIComponent(item[1].trim())})}return{path:base.split("/"),query:queryVars,fragment:fragment}},decodePath:function(path){path=parsePath(path);var type=path.path[0]||"";var id=path.path[1];if(id!=undefined){if(/^-?\d+$/.test(id))id=+id}path.id=id;path.type=type;return path},render:function(path,after){path=String(path);var path=decodePath(path);$.View.handleView(path.type,path.id,path.query,after)}});$.onpopstate=function(){init=true;initialPop=true;updateFromLocation()}}(window);Sidebar.print("hi!");delete window.sidebar;window.onerror=function(message,source,line,col,error){try{Sidebar.print("Error: "+message+"\nin "+source+"\nat "+line+":"+col)}catch(e){}};Req.onLogin=function(){View.flag("loggedIn",true);Req.onMessages=function(comments){ChatRoom.displayMessages(comments)};Req.onListeners=function(a){ChatRoom.updateUserLists(a)};Req.onActivity=function(a){a.forEach(function(a){if(a.type=="user"){View.updateUserAvatar(a.content)}})};console.log("staring long poller");Req.lpStart(function(e,resp){if(!e){var me=resp.chains.Ume;if(me&&me[0])View.updateMyUser(me[0])}else{alert("INITIAL LONG POLL FAILED!")}})};Req.onGuestLoad=function(){};Req.onLogout=function(){View.flag("loggedIn",false)};Req.tryLoadCachedAuth();if(document.readyState=="loading")document.addEventListener("DOMContentLoaded",ready);else ready();function ready(){console.log("ONLOAD!");if(navigator.vendor=="Google Inc."){console.info("chrome sucks");var x=document.createElement("style");x.textContent="img, .iconBg { image-rendering: -webkit-optimize-contrast; }";document.head.appendChild(x)}View.onLoad();Nav.initial()}